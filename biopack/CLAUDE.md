# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

BioPack is a comprehensive NMR (Nuclear Magnetic Resonance) spectroscopy pulse sequence library for biomolecular NMR spectroscopy, developed for the VnmrJ/OpenVNMRJ NMR software platform. It contains over 400 pulse sequences optimized for protein, peptide, RNA, and DNA structure determination and dynamics studies.

This is part of the OpenVNMRJ 3.2A installation, specifically the BioPack application component located at `/home/openvnmrj_3.2_A/biopack` with a system installation at `/vnmr/biopack`.

## Architecture

### Directory Structure

- **psglib/** - Pulse sequence source code (405 .c files)
  - Main pulse sequences implementing NMR experiments
  - Each .c file is a complete pulse sequence program
  - Uses VnmrJ PSG (Pulse Sequence Generator) framework

- **psg/** - Header files for pulse sequence programming
  - `bionmr.h` - Core BioPack functions and macros for protein/RNA experiments
  - `Pbox_bio.h` - Pbox integration for shaped pulse generation
  - `mfpresat.h` - Multi-frequency presaturation
  - `CompSens.h`, `PpP.h`, `PRexp.h` - Specialized experiment modules

- **maclib/** - Macro library for experiment setup and automation
  - Setup macros for each pulse sequence (e.g., `ghn_ca`, `ghn_co`)
  - `BPrtppar()` - Central parameter retrieval from probe files
  - Macros prefixed with `BP*` are BioPack-specific utilities
  - Macros prefixed with `best_*` are for SOFAST/BEST experiments

- **parlib/** - Parameter sets (.par files) for experiments
  - Pre-configured parameter files for each pulse sequence
  - Contains optimized acquisition parameters

- **manual/** - Documentation files for each pulse sequence

- **shapelib/** - RF pulse shapes for selective excitation

- **tablib/** - Delay tables and other tabulated data

- **templates/** - VnmrJ GUI layouts and interface definitions
  - `layout/` - Sequence-specific XML files defining acquisition/processing pages
  - `vnmrj/interface/` - Top-level menu definitions
  - `vnmrj/panelitems/` - Reusable GUI panel components
  - `vnmrj/protocols/` - Protocol definitions for StudyQueue/automation

- **seqlib/** - Compiled pulse sequences (binary executables)
  - Generated by `seqgen` from psglib/ source files
  - 32-bit ELF executables run by VnmrJ during experiments

- **bin/** - Utility scripts
  - NMR data processing utilities
  - Non-linear sampling (NLS) tools

- **BioPack.dir/** - Installation metadata
  - `BioPack.README` - Comprehensive documentation and revision history
  - Version tracking and file catalogs

## Key Concepts

### Pulse Sequence Organization

Pulse sequences are grouped by experiment type:

1. **Protein experiments** - Triple resonance (H/C/N), relaxation, NOESY variants
   - `ghn_*` sequences: H-N correlation experiments (HNCO, HNCA, HNCACB, etc.)
   - `ghc_*` sequences: H-C correlation experiments
   - `gcbca_*` sequences: Sidechain assignment experiments

2. **RNA/DNA experiments** - Sequences prefixed with `rna_`
   - `rna_gChsqc`, `rna_gNhsqc` - Basic 2D correlations
   - `rna_hcch_tocsy`, `rna_HNNcosy` - Through-bond correlations
   - `rna_*_CCdec` - Carbon homodecoupling versions

3. **TROSY variants** - For large proteins/deuterated samples
   - Many sequences have TROSY option via flag
   - Dedicated TROSY sequences: `*_trosy_*`

4. **BEST/SOFAST sequences** - Fast acquisition methods
   - Prefixed with `best_*` or `sofast*`
   - Use band-selective pulses for rapid pulsing

### Naming Conventions

Pulse sequence naming follows systematic patterns:

- `g` prefix = gradient-enhanced
- Nucleus order in name = magnetization transfer path
  - Example: `ghn_co_ca` = H→N→CO→CA correlation
  - Example: `gcbca_co_nh` = CB/CA→CO→N→H

- Suffixes indicate variants:
  - `P` = Uses Pbox with pre-defined protein C13 bands ("ca", "co", "cacb")
  - `A` = Auto-creates all shapes at "go" time using Pbox
  - No suffix = Traditional version with pre-generated shapes
  - `SP` = SpinCAD version (for UNITY INOVA only, not DirectDrive)

### Probe Files and Calibrations

BioPack uses a probe file system (similar to Chempack):

- Calibrations stored in probe files, not parameter sets
- `BPrtppar('sequence_name')` retrieves parameters from active probe file
- Setup macros set experiment-specific values (offsets, gradients, spectral widths)
- AutoCalibration/AutoUpdate processes maintain probe files

### Shaped Pulse Generation

Three approaches for shaped pulses:

1. **Pre-generated shapes** in shapelib/ (traditional sequences)
2. **"P" versions** - Use bionmr.h psg elements with pre-defined C13 bands
3. **"A" versions** - Auto-generate shapes at runtime via Pbox

### C13 Frequency Bands

Common carbon regions defined in `psg/bionmr.h`:

- `"co"` - Carbonyl region (175 ppm reference)
- `"ca"` - Alpha carbons (56 ppm)
- `"cb"` - Beta carbons (35 ppm)
- `"cab"` - Combined CA/CB (46 ppm)
- `"aliph"` - Aliphatic carbons (42 ppm)
- `"methyl"` - Methyl groups (19 ppm)
- `"arom"` - Aromatic carbons (125 ppm)

Function `get_c13dof(fband)` calculates offset for each band.

## How Pulse Sequences and Macros Work Together

### Workflow Overview

1. **User runs setup macro** (e.g., `ghn_co`)
   - Macro calls `BPrtppar('ghn_co')` to load parameter set from `parlib/ghn_co.par/`
   - Retrieves calibrations from active probe file (not from parameter set)
   - Calculates pulse widths, power levels, and offsets
   - For traditional sequences: calls shape generation macros (e.g., `BPmake180Ca_CO`)
   - Sets initial values: `ni=0 ni2=0 phase=1 phase2=1` for 1D check

2. **Shape generation** (traditional sequences only)
   - Macro creates hard pulse shape with specified steps using `BPmakehard()`
   - Convolutes with frequency offset using `BPconvolute()` to create SLP pulse
   - Stores `.RF` file in `shapelib/` (e.g., `offC3.RF`)
   - Shape files contain: phase, amplitude, gate for each time step

3. **User runs `go` or `au`**
   - VnmrJ compiles sequence if needed (`seqgen` → `seqlib/` executable)
   - Executes compiled pulse sequence with current parameters

4. **Pulse sequence execution** (C code in `psglib/`)
   - Reads parameters using `getval()` (e.g., `pwC = getval("pwC")`)
   - Reads string flags using `getstr()` (e.g., `getstr("TROSY",TROSY)`)
   - Calculates derived values (tau1, tau2, phase increments)
   - For "P" versions: calls functions from `bionmr.h` (e.g., `c13pulsepw()`)
   - For "A" versions: auto-generates shapes with Pbox at runtime via `Pbox_bio.h`
   - Executes RF pulses, gradients, and delays
   - Uses shaped pulses via `decshaped_pulse()`, `shaped_pulse()`
   - Hard pulses via `rgpulse()`, `decrgpulse()`, `dec2rgpulse()`

### Three Approaches to Shaped Pulses

**Traditional sequences** (no suffix):
- Pre-generated shapes in `shapelib/` (e.g., `offC3.RF`, `offC6.RF`, `offC8.RF`)
- Setup macro explicitly creates shapes before acquisition
- Pulse sequence references shapes by name: `decshaped_pulse("offC6", pwC6, t3, 0.0, 0.0)`

**"P" versions** (Pbox with pre-defined bands):
- Include `#include "bionmr.h"` in pulse sequence
- Use C13 band names: "co", "ca", "cb", "cab", "aliph", "methyl", "arom"
- Call `c13pulsepw("ca", "co", "square", 180.0)` to calculate pulse width
- Call `c13shapefiles()` to generate shapes via Pbox if needed
- Pbox creates optimized shapes in `shapelib/` with names like `pp.co.sinc.co.ca.90.RF`
- Functions handle frequency offsets automatically via `set_c13offset("ca")`

**"A" versions** (Auto-create with Pbox):
- Include `#include "Pbox_bio.h"` and `#include "Pbox_psg.h"`
- Shapes generated automatically at "go" time via Pbox on-the-fly
- No pre-existing shape files required
- Uses `pbox()`, `pbox_make()` functions to create shapes in memory

### Parameter Flow

```
Probe File (system calibrations)
    ↓
BPrtppar() macro loads parlib/*.par and retrieves from probe file
    ↓
Setup macro (maclib/sequence_name) calculates experiment-specific values
    ↓
User adjusts parameters in VnmrJ GUI
    ↓
Pulse sequence code (psglib/sequence_name.c) reads via getval()/getstr()
    ↓
Compiled sequence (seqlib/sequence_name) executes on spectrometer
```

### Key Functions in Pulse Sequences

**Parameter retrieval:**
- `getval("param")` - Get numeric parameter value
- `getstr("param", variable)` - Get string parameter

**RF pulses:**
- `rgpulse(pw, phase, rof1, rof2)` - H1 hard pulse
- `decrgpulse(pw, phase, rof1, rof2)` - C13 hard pulse (channel 2)
- `dec2rgpulse(pw, phase, rof1, rof2)` - N15 hard pulse (channel 3)
- `shaped_pulse("shape", pw, phase, rof1, rof2)` - Shaped pulse
- `decshaped_pulse("shape", pw, phase, rof1, rof2)` - C13 shaped pulse
- `sim3pulse(pw1, pw2, pw3, phase1, phase2, phase3, rof1, rof2)` - Simultaneous 3-channel pulse

**Gradients:**
- `zgradpulse(level, time)` - Z-gradient pulse
- `rgradient(axis, level)` - Gradient on specified axis

**Timing:**
- `delay(time)` - Fixed delay in seconds
- `status(A/B/C/D)` - Change status for decoupler control

**Phase cycling:**
- `settable(table, size, array)` - Load phase table
- `tsadd(table, value, modulo)` - Add to phase table for States-TPPI
- `getelem(table, counter, phase)` - Get phase from table

## VnmrJ GUI Templates

### Template Architecture

BioPack uses XML templates to define the VnmrJ graphical interface. Templates control how parameters are displayed, edited, and organized in the GUI.

### Layout Templates (templates/layout/)

Each pulse sequence has its own directory containing XML files that define tabs and panels:

**Common layout files:**
- `DEFAULT` - Points to a default template set (e.g., "set default default3dBP")
- `Acquisition.xml` - Main acquisition parameter tab (spectral widths, increments, gain, etc.)
- `PulseSequence.xml` - Pulse sequence-specific parameters (TROSY, timeTN, gradients, etc.)
- `acq.xml` - Tab definitions and references (defines which panels appear as tabs)

**Example: ghn_co/Acquisition.xml structure:**
```xml
<template name="Acquisition" element="pages" type="acquisition">
  <group size="784 272" label="Acquisition" tab="yes">
    <!-- F3 Acquisition: NH Protons -->
    <group loc="0 0" size="256 248">
      <entry vq="sw" vc="vnmrunits('set','sw',$VALUE)"
             set="vnmrunits('get','sw'):$VALUE"/>
      <entry vq="np" vc="np=$VALUE*2" set="$VALUE=(np/2)"/>
      <entry vq="nt" vc="nt=$VALUE" set="$VALUE=nt"/>
    </group>

    <!-- F1 Acquisition: Carbonyl 13Cs -->
    <group loc="272 0" size="243 248">
      <entry vq="sw1" vc="vnmrunits('set','sw1',$VALUE)"/>
      <entry vq="ni" vc="ni=$VALUE" set="$VALUE=ni"/>
      <check vq="f1180" vc="f1180='y'" vc2="f1180='n'"/>
    </group>

    <!-- F2 Acquisition: 15Ns -->
    <group loc="528 0" size="248 248">
      <entry vq="sw2" vc="vnmrunits('set','sw2',$VALUE)"/>
      <entry vq="ni2" vc="ni2=$VALUE" set="$VALUE=ni2"/>
      <check vq="f2180" vc="f2180='y'" vc2="f2180='n'"/>
    </group>
  </group>
</template>
```

### GUI Element Types

**entry** - Text input field:
- `vq="param"` - Parameter to query/monitor
- `vc="param=$VALUE"` - Command to execute on change
- `set="$VALUE=param"` - Expression to get current value
- `digits="3"` - Number of decimal places
- `show="if condition then $VALUE=1 else $VALUE=0 endif"` - Visibility condition

**check** - Checkbox:
- `vc="param='y'"` - Command when checked
- `vc2="param='n'"` - Command when unchecked
- `set="if param='y' then $VALUE=1 else $VALUE=0 endif"` - Get checked state

**radio** - Radio button (mutually exclusive options)

**menu** - Drop-down menu:
- `<mlabel label="ppm" chval="ppm1"/>` - Menu options

**button** - Clickable button:
- `vc="seqfil='ghn_coP' layout=seqfil"` - Command to execute

**label** - Static text label

**textmessage** - Read-only computed value:
- `set="if ni>1 then $VALUE=sw1/ni else $VALUE=0 endif"` - Calculation expression

**group** - Container for organizing elements:
- `loc="x y"` - Position in pixels
- `size="width height"` - Dimensions
- `border="Etched"` - Border style
- `show="condition"` - Conditional visibility

### VnmrJ Interface Files (templates/vnmrj/)

**interface/*.xml** - Main menu definitions:
- `BioPackActivate.xml` - BioPack activation menu options
- `BioPackTriple.xml` - Triple resonance experiment menu
- `BioPackHSQC.xml` - HSQC experiment menu
- `BioPackRNA.xml` - RNA experiment menu
- `TopPanel.xml` - Top panel modifications

**panelitems/*.xml** - Reusable components:
- Small, self-contained GUI elements that can be referenced from other templates
- Example: `bpexpress_params.xml` defines parameter input for BioPack Express

**protocols/*.xml** - Automation protocols:
```xml
<template type="basic" name="ProTripleRes_3D_ProjRecon_HNCO"
         label="HNCO" menu1="ProTripleRes"
         menu2="3D Projection-Reconstruction (TILT)"
         seqfil="ghn_co" apptype="BioPack">
  <protocol title="ProTripleRes_3D_ProjRecon_HNCO" type="protocol">
    <action type="LIB" status="Ready" title="..."
            macro="ghn_co" time="0:09"/>
  </protocol>
</template>
```

Protocols organize experiments into hierarchical menus for StudyQueue and define:
- Experiment name and categorization
- Associated pulse sequence (`seqfil`)
- Setup macro to run
- Estimated acquisition time

### Template References

Templates use a reference system to reuse common layouts:

**useref="yes"** - Reference another template by name:
```xml
<group label="Acquisition" reference="Acquisition" useref="yes"/>
```

This imports the content from another Acquisition.xml template, avoiding duplication.

**DEFAULT file** - Points to a base template set:
```
set default default3dBP
```

Common defaults:
- `default3dBP` - Standard 3D triple resonance layout
- `default2dBP` - Standard 2D HSQC/HMQC layout
- `default4dBP` - 4D experiment layout

### Creating New Templates

When creating a new pulse sequence, template files typically needed:

1. **Create layout directory:**
   ```bash
   mkdir templates/layout/new_sequence_name
   ```

2. **Create DEFAULT file** pointing to appropriate base template

3. **Create Acquisition.xml** with parameter groups for each dimension

4. **Create PulseSequence.xml** with sequence-specific controls

5. **Create acq.xml** defining tab structure and references

6. **Optional: Create protocol** in `vnmrj/protocols/` for StudyQueue integration

### Template Loading Flow

```
VnmrJ starts
   ↓
Reads apptype (BioPack) from parameter set
   ↓
Loads templates/vnmrj/interface/ menu files
   ↓
User selects sequence or runs setup macro
   ↓
VnmrJ looks for templates/layout/sequence_name/
   ↓
Reads DEFAULT file for base template
   ↓
Loads acq.xml to determine tab structure
   ↓
For each tab, loads referenced XML files
   ↓
Renders GUI with parameter bindings (vq/vc/set)
   ↓
User edits parameters → vc commands execute → parameters update
```

## Template Development Guide

### Step-by-Step: Creating Templates for a New Pulse Sequence

#### Step 1: Determine Template Base

Choose based on dimensionality:
- **2D sequences** (ni only): Use existing 2D template as reference (e.g., `gNhsqc`)
- **3D sequences** (ni, ni2): Use `default3dBP` via DEFAULT file
- **4D sequences** (ni, ni2, ni3): Use `default4dBP`

#### Step 2: Create Layout Directory Structure

```bash
cd templates/layout
mkdir my_new_sequence
cd my_new_sequence
```

#### Step 3: Create DEFAULT File

Point to appropriate base template:

**For 3D sequence:**
```bash
echo "set default default3dBP" > DEFAULT
```

**For 2D sequence:**
```bash
echo "set default default2dBP" > DEFAULT
```

#### Step 4: Create acq.xml (Tab Structure)

This file defines which tabs appear and which templates they reference:

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<template name="Acquire" element="panels" type="acquisition" >
  <!-- Basic Parameters Tab -->
  <group loc="0 0" size="736 248"
    label="Basic"
    show="if (BPbasic=1) then $SHOW=1 else $SHOW=0 endif"
    tab="yes"
    reference="Basic"
    useref="yes"
    subtype="Basic"
    >
  </group>

  <!-- Acquisition Tab -->
  <group loc="0 0" size="736 248"
    label="Acquisition"
    tab="yes"
    reference="Acquisition"
    useref="yes"
    subtype="Basic"
    >
  </group>

  <!-- Pulse Sequence Tab -->
  <group loc="0 0" size="680 260"
    label="Pulse Sequence"
    tab="yes"
    reference="PulseSequence"
    useref="yes"
    subtype="Basic"
    >
  </group>

  <!-- Channels Tab (common to all) -->
  <group loc="0 0" size="784 243"
    label="Channels"
    tab="yes"
    reference="Channels"
    useref="yes"
    subtype="Basic"
    >
  </group>
</template>
```

**Key attributes:**
- `reference="Name"` - Links to Name.xml file
- `useref="yes"` - Load content from referenced file
- `tab="yes"` - Make this a tab in the GUI
- `show="condition"` - Conditionally display tab

#### Step 5: Create Acquisition.xml

Define parameter groups for each dimension. **Critical: Organize by dimension (F1, F2, F3)**

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<template name="Acquisition" element="pages" type="acquisition" >
  <group size="784 272"
    label="Acquisition"
    tab="yes"
    reference="Acquisition"
    expanded="yes"
    >

    <!-- Label showing sequence name -->
    <label loc="530 245" size="175 25"
      style="Heading2"
      label="my_new_sequence.c"
      />

    <!-- ============================================ -->
    <!-- F3 Acquisition: Direct Dimension (1H)        -->
    <!-- ============================================ -->
    <group loc="0 0" size="256 248"
      border="Etched"
      subtype="Titled"
      >
      <label loc="8 0" size="248 24"
        style="Heading2"
        label="F3 Acquisition : Protons"
        />

      <!-- Spectral Width -->
      <label loc="8 24" size="112 24"
        label="Spectral width"
        />
      <entry loc="136 24" size="56 24"
        vq="sw"
        vc="vnmrunits('set','sw',$VALUE)"
        set="vnmrunits('get','sw'):$VALUE"
        digits="1"
        />
      <menu loc="192 24" size="56 24"
        vq="sw"
        vc="parunits('set','sw','$VALUE')"
        set="parunits('get','sw'):$VALUE"
        editable="No"
        >
        <mlabel label="ppm" chval="ppm1"/>
        <mlabel label="Hz" chval="Hz"/>
      </menu>

      <!-- Acquisition Time -->
      <label loc="8 48" size="112 24"
        label="Acquisition time"
        />
      <entry loc="136 48" size="56 24"
        vq="at"
        vc="vnmrunits('set','at',$VALUE)"
        set="vnmrunits('get','at'):$VALUE"
        digits="3"
        />
      <menu loc="192 48" size="56 24"
        vq="at"
        vc="parunits('set','at','$VALUE')"
        set="parunits('get','at'):$VALUE"
        editable="No"
        >
        <mlabel label="sec" chval="sec"/>
        <mlabel label="ms" chval="ms"/>
        <mlabel label="us" chval="us"/>
      </menu>

      <!-- Complex Points -->
      <label loc="24 72" size="96 24"
        label="complex points"
        />
      <entry loc="136 72" size="56 24"
        vq="np"
        vc="np=$VALUE*2"
        set="$VALUE=(np/2)"
        />

      <!-- Number of Transients -->
      <label loc="8 104" size="112 16"
        label="Scans: Requested"
        />
      <entry loc="136 104" size="56 16"
        vq="nt"
        vc="nt=$VALUE"
        set="$VALUE=nt"
        />

      <!-- Completed Scans (read-only) -->
      <label loc="48 120" size="64 16"
        label="Completed"
        />
      <textmessage loc="136 120" size="56 16"
        style="Label3"
        label="0"
        vq="ct"
        set="$VALUE=ct"
        />

      <!-- Steady State Scans -->
      <label loc="48 136" size="80 16"
        label="Steady-State"
        />
      <entry loc="136 136" size="56 16"
        vq="ss"
        vc="ss=$VALUE"
        set="$VALUE=ss"
        show="if ss=0 then $VALUE=0 else $VALUE=1 endif"
        />

      <!-- Receiver Gain -->
      <label loc="8 160" size="88 24"
        label="Receiver Gain"
        />
      <entry loc="136 160" size="24 24"
        vq="gain"
        vc="gain=$VALUE"
        set="$VALUE=gain"
        show="on('gain'):$VALUE"
        />
      <check loc="160 160" size="16 24"
        vq="gain"
        vc="gain='n'"
        vc2="gain='y'"
        set="off('gain'):$VALUE"
        />
      <label loc="184 160" size="32 24"
        style="Label1"
        label="Auto"
        />

      <!-- Relaxation Delay -->
      <label loc="8 184" size="112 24"
        label="Relaxation delay"
        />
      <entry loc="136 184" size="48 24"
        vq="d1"
        vc="vnmrunits('set','d1',$VALUE)"
        set="vnmrunits('get','d1'):$VALUE"
        show="if (d1=0) then $VALUE=0 else $VALUE=1 endif"
        digits="3"
        />
      <menu loc="192 184" size="56 24"
        vq="d1"
        vc="parunits('set','d1','$VALUE')"
        set="parunits('get','d1'):$VALUE"
        editable="No"
        >
        <mlabel label="sec" chval="sec"/>
        <mlabel label="ms" chval="ms"/>
        <mlabel label="us" chval="us"/>
      </menu>
    </group>

    <!-- ============================================ -->
    <!-- F1 Acquisition: First Indirect Dimension     -->
    <!-- ============================================ -->
    <group loc="272 0" size="243 248"
      border="Etched"
      subtype="Titled"
      >
      <label loc="8 0" size="232 24"
        style="Heading2"
        label="F1 Acquisition: 13C Carbonyl"
        vq="ni"
        />

      <!-- Spectral Width -->
      <label loc="8 24" size="88 24"
        label="Spectral width"
        />
      <entry loc="96 24" size="56 24"
        vq="sw1"
        vc="vnmrunits('set','sw1',$VALUE)"
        set="vnmrunits('get','sw1'):$VALUE"
        show="if (ni=0) or (ni=1) then $VALUE=0 else $VALUE=1 endif"
        digits="1"
        />
      <menu loc="152 24" size="80 24"
        vq="sw1"
        vc="parunits('set','sw1','$VALUE')"
        set="parunits('get','sw1'):$VALUE"
        editable="No"
        >
        <mlabel label="C13 ppm" chval="ppm2"/>
        <mlabel label="Hz" chval="Hz"/>
      </menu>

      <!-- Number of Increments -->
      <label loc="8 48" size="112 24"
        label="Increments in t1"
        />
      <entry loc="112 48" size="40 24"
        vq="ni"
        vc="ni=$VALUE"
        set="$VALUE=ni"
        show="if (ni=0) or (ni=1) then $VALUE=0 else $VALUE=1 endif"
        />

      <!-- Calculated values (only show when ni>1) -->
      <group loc="8 72" size="232 40"
        vq="ni"
        show="if ni&gt;1 then $VALUE=1 else $VALUE=0 endif"
        >
        <label loc="0 0" size="136 24"
          label="Acquisition time (max)"
          />
        <textmessage loc="136 0" size="56 24"
          label="0.000000"
          vq="ni sw1"
          set="if ni&gt;1 then $VALUE=ni/sw1 else $VALUE=0 endif"
          digits="6"
          />
        <label loc="192 0" size="32 24"
          label="sec."
          />

        <label loc="8 24" size="72 16"
          label="Resolution:"
          />
        <textmessage loc="80 24" size="32 16"
          label="0"
          vq="ni sw1"
          set="if ni&gt;1 then $VALUE=sw1/ni else $VALUE=0 endif"
          digits="0"
          />
        <label loc="112 24" size="40 16"
          label="Hz, or"
          />
        <textmessage loc="152 24" size="40 16"
          label="0.00"
          vq="ni sw1 dfrq"
          set="if ni&gt;1 then $VALUE=(sw1/ni)/dfrq else $VALUE=0 endif"
          digits="2"
          />
        <label loc="192 24" size="40 16"
          label="ppm"
          />
      </group>

      <!-- Initial Evolution Time -->
      <label loc="8 120" size="152 24"
        style="Label3"
        label="Initial Evolution Time"
        />
      <entry loc="136 120" size="80 24"
        style="Label2"
        vq="d2"
        vc="d2=$VALUE"
        set="$VALUE=d2"
        show="if d2=0 then $VALUE=0 else $VALUE=1 endif"
        />

      <!-- Half-Dwell Delay -->
      <check loc="8 144" size="152 24"
        label="Half-Dwell Delay in t1"
        vq="f1180"
        vc="f1180='y'"
        vc2="f1180='n'"
        set="if f1180='y' then $VALUE=1 else $VALUE=0 endif"
        />

      <!-- Acquisition Mode -->
      <label loc="8 168" size="104 24"
        label="Acquisition Mode"
        />
      <radio loc="32 192" size="128 24"
        label="First Increment"
        vq="phase"
        vc="phase=1"
        set="if phase=1 then $VALUE=1 else $VALUE=0 endif"
        />
      <radio loc="32 216" size="128 24"
        label="Hypercomplex"
        vq="phase"
        vc="phase=1,2"
        set="$VALUE=0 $phase=size('phase') if $phase&gt;1.5 then $v=(phase[1]=1) $w=(phase[2]=2) $VALUE=($v and $w) endif"
        />
    </group>

    <!-- ============================================ -->
    <!-- F2 Acquisition: Second Indirect Dimension    -->
    <!-- ============================================ -->
    <group loc="528 0" size="248 248"
      border="Etched"
      subtype="Titled"
      >
      <label loc="8 0" size="232 24"
        style="Heading2"
        label="F2 Acquisition: 15N"
        />

      <!-- Spectral Width -->
      <label loc="8 24" size="88 24"
        label="Spectral width"
        />
      <entry loc="96 24" size="56 24"
        vq="sw2"
        vc="vnmrunits('set','sw2',$VALUE)"
        set="vnmrunits('get','sw2'):$VALUE"
        show="if (ni2=0) or (ni2=1) then $VALUE=0 else $VALUE=1 endif"
        digits="1"
        />
      <menu loc="152 24" size="88 24"
        vq="sw2"
        vc="parunits('set','sw2','$VALUE')"
        set="parunits('get','sw2'):$VALUE"
        editable="No"
        >
        <mlabel label="N15 ppm" chval="ppm3"/>
        <mlabel label="Hz" chval="Hz"/>
      </menu>

      <!-- Number of Increments -->
      <label loc="8 48" size="112 24"
        label="Increments in t2"
        justify="Left"
        />
      <entry loc="104 48" size="40 24"
        vq="ni2"
        vc="ni2=$VALUE"
        set="$VALUE=ni2"
        show="if (ni2=0) or (ni2=1) then $VALUE=0 else $VALUE=1 endif"
        disable="Grayed out"
        />

      <!-- Calculated values (only show when ni2>1) -->
      <group loc="8 72" size="232 40"
        vq="ni2"
        show="if ni2&gt;1 then $VALUE=1 else $VALUE=0 endif"
        >
        <label loc="0 0" size="136 24"
          label="Acquisition time (max)"
          />
        <textmessage loc="136 0" size="72 24"
          label="0.000000"
          vq="ni2 sw2"
          set="if ni2&gt;1 then $VALUE=ni2/sw2 else $VALUE=0 endif"
          digits="6"
          />
        <label loc="200 0" size="32 24"
          label="sec."
          />

        <label loc="8 24" size="72 16"
          label="Resolution:"
          />
        <textmessage loc="80 24" size="32 16"
          label="0"
          vq="ni2 sw2"
          set="if ni2&gt;1 then $VALUE=sw2/ni2 else $VALUE=0 endif"
          digits="0"
          />
        <label loc="112 24" size="40 16"
          label="Hz, or"
          />
        <textmessage loc="152 24" size="40 16"
          label="0.00"
          vq="ni2 sw2 dfrq2"
          set="if ni2&gt;1 then $VALUE=(sw2/ni2)/dfrq2 else $VALUE=0 endif"
          digits="2"
          />
        <label loc="192 24" size="40 16"
          label="ppm"
          />
      </group>

      <!-- Initial Evolution Time -->
      <label loc="8 120" size="152 24"
        style="Label3"
        label="Initial Evolution Time"
        />
      <entry loc="128 120" size="80 24"
        style="Label2"
        vq="d3"
        vc="d3=$VALUE"
        set="$VALUE=d3"
        show="if d3=0 then $VALUE=0 else $VALUE=1 endif"
        />

      <!-- Half-Dwell Delay -->
      <check loc="8 144" size="152 24"
        label="Half-Dwell Delay in t2"
        vq="f2180"
        vc="f2180='y'"
        vc2="f2180='n'"
        set="if f2180='y' then $VALUE=1 else $VALUE=0 endif"
        />

      <!-- Acquisition Mode -->
      <label loc="8 168" size="104 24"
        label="Acquisition Mode"
        />
      <radio loc="32 192" size="128 24"
        label="First Increment"
        vq="phase2"
        vc="phase2=1"
        set="if phase2=1 then $VALUE=1 else $VALUE=0 endif"
        />
      <radio loc="32 216" size="136 24"
        label="Hypercomplex"
        vq="phase2"
        vc="phase2=1,2"
        set="$VALUE=0 $phase=size('phase2') if $phase&gt;1.5 then $v=(phase2[1]=1) $w=(phase2[2]=2) $VALUE=($v and $w) endif"
        />
    </group>

  </group>
</template>
```

**Key patterns:**
- **vq (value query)** - Parameter(s) to monitor for changes
- **vc (value command)** - MAGICAL command executed when user changes value
- **set** - Expression to get current value for display
- **show** - Conditional visibility (0=hidden, 1=visible)
- **disable** - "Grayed out" makes read-only but visible

#### Step 6: Create PulseSequence.xml

Sequence-specific parameters and options:

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<template name="PulseSequence" element="pages" type="acquisition" >
  <group size="752 272"
    label="Pulse Sequence"
    tab="yes"
    reference="PulseSequence"
    expanded="yes"
    >

    <!-- ========================================== -->
    <!-- Sequence Version Selection                 -->
    <!-- ========================================== -->
    <group loc="10 0" size="335 270"
      border="Etched"
      subtype="Titled"
      >
      <label loc="16 8" size="216 24"
        style="Heading2"
        label="Change Sequence Version:"
        />

      <!-- Button to switch to "P" version -->
      <button loc="80 35" size="120 25"
        style="Label3"
        label="BioNMR Version"
        vq="seqfil layout"
        vc="seqfil='my_new_sequenceP' layout=seqfil"
        tooltip="seqfil='my_new_sequenceP'"
        halignment="Center"
        />

      <!-- Button to switch to "A" version -->
      <button loc="80 65" size="120 25"
        style="Label3"
        label="Pbox Version"
        vq="seqfil layout"
        vc="seqfil=seqfil+'A' layout=seqfil"
        tooltip="seqfil=seqfil+'A'"
        halignment="Center"
        />

      <!-- TROSY Option -->
      <check loc="176 120" size="80 24"
        style="Heading1"
        label="TROSY"
        vq="TROSY dm2"
        vc="TROSY='y' dm2='nnn'"
        vc2="TROSY='n'"
        set="if TROSY='y' then $VALUE=1 else $VALUE=0 endif"
        tooltip="TROSY='y' dm2='nnn'"
        />

      <!-- Semi-Constant Time Option -->
      <check loc="8 120" size="128 24"
        style="Heading2"
        label="N15 Semi-CT"
        vq="SCT"
        vc="SCT='y'"
        vc2="SCT='n'"
        set="if SCT='y' then $VALUE=1 else $VALUE=0 endif"
        tooltip="SCT='y'"
        />

      <!-- Constant Time Evolution Period -->
      <label loc="8 168" size="64 24"
        label="timeTN"
        justify="Left"
        />
      <entry loc="72 168" size="48 24"
        vq="timeTN"
        vc="timeTN=$VALUE"
        set="$VALUE=timeTN"
        digits="3"
        disable="Grayed out"
        />

      <!-- 1H Decoupling Strength -->
      <group loc="4 192" size="258 24"
        reference="1HDecouplingStrength"
        >
        <label loc="0 0" size="144 24"
          label="1H Decoupling Strength"
          justify="Left"
          />
        <entry loc="138 0" size="54 24"
          vq="waltzB1"
          vc="vnmrunits('set','waltzB1',$VALUE)"
          set="vnmrunits('get','waltzB1'):$VALUE"
          digits="1"
          disable="Grayed out"
          tooltip="waltzB1"
          />
        <menu loc="186 0" size="54 24"
          vq="waltzB1"
          vc="parunits('set','waltzB1','$VALUE')"
          set="parunits('get','waltzB1'):$VALUE"
          editable="No"
          >
          <mlabel label="ppm" chval="ppm1"/>
          <mlabel label="Hz" chval="Hz"/>
        </menu>
      </group>

      <!-- Pre & Post-Pulse Delays -->
      <label loc="2 220" size="220 20"
        label="Pre  &amp; Post-Pulse Delays (rof1,rof2)"
        justify="Left"
        />
      <entry loc="232 220" size="40 20"
        vq="rof1"
        vc="rof1=$VALUE"
        set="$VALUE=rof1"
        digits="1"
        disable="Grayed out"
        />
      <entry loc="282 220" size="40 20"
        vq="rof2"
        vc="rof2=$VALUE"
        set="$VALUE=rof2"
        digits="1"
        disable="Grayed out"
        />

      <!-- Pre-Acquisition Delay -->
      <label loc="4 240" size="168 24"
        label="Pre-Acquisition Delay (alfa)"
        justify="Left"
        />
      <entry loc="208 240" size="48 24"
        vq="alfa"
        vc="alfa=$VALUE"
        set="$VALUE=alfa"
        digits="1"
        />
    </group>

    <!-- ========================================== -->
    <!-- Gradient Parameters                        -->
    <!-- ========================================== -->
    <group loc="352 0" size="400 272"
      border="Etched"
      subtype="Titled"
      >
      <label loc="16 8" size="96 24"
        style="Heading2"
        label="Gradients"
        justify="Left"
        />

      <!-- Coherence Transfer Gradients -->
      <label loc="16 40" size="200 24"
        style="Heading2"
        label="Coherence Transfer"
        justify="Left"
        />

      <!-- gzlvl1 -->
      <label loc="120 64" size="40 24"
        label="gzlvl1"
        justify="Left"
        />
      <entry loc="168 64" size="48 24"
        vq="gzlvl1"
        vc="gzlvl1=$VALUE"
        set="$VALUE=gzlvl1"
        digits="0"
        disable="Grayed out"
        />
      <entry loc="240 64" size="64 24"
        vq="gzlvl1 gzcal"
        vc="gzlvl1=$VALUE/gzcal"
        set="$VALUE=gzlvl1*gzcal"
        digits="3"
        disable="Grayed out"
        />
      <entry loc="328 64" size="64 24"
        vq="gt1"
        vc="gt1=$VALUE"
        set="$VALUE=gt1"
        digits="6"
        disable="Grayed out"
        />

      <!-- gzlvl2 -->
      <label loc="120 88" size="40 24"
        label="gzlvl2"
        justify="Left"
        />
      <entry loc="168 88" size="48 24"
        vq="gzlvl2"
        vc="gzlvl2=$VALUE"
        set="$VALUE=gzlvl2"
        digits="0"
        disable="Grayed out"
        />
      <entry loc="240 88" size="64 24"
        vq="gzlvl2 gzcal"
        vc="gzlvl2=$VALUE/gzcal"
        set="$VALUE=gzlvl2*gzcal"
        digits="3"
        disable="Grayed out"
        />
      <entry loc="328 88" size="64 24"
        vq="gt2"
        vc="gt2=$VALUE"
        set="$VALUE=gt2"
        digits="6"
        disable="Grayed out"
        />

      <!-- Column Headers -->
      <label loc="168 112" size="48 24"
        style="Label1"
        label="DAC"
        justify="Center"
        />
      <label loc="240 112" size="64 24"
        style="Label1"
        label="G/cm"
        justify="Center"
        />
      <label loc="328 112" size="64 24"
        style="Label1"
        label="Time (sec)"
        justify="Center"
        />

      <!-- Homospoil Gradients -->
      <label loc="16 136" size="96 24"
        style="Heading2"
        label="Homospoils"
        justify="Left"
        />

      <!-- gzlvl0 -->
      <label loc="120 160" size="40 24"
        label="gzlvl0"
        justify="Left"
        />
      <entry loc="168 160" size="48 24"
        vq="gzlvl0"
        vc="gzlvl0=$VALUE"
        set="$VALUE=gzlvl0"
        digits="0"
        disable="Grayed out"
        />
      <entry loc="240 160" size="64 24"
        vq="gzlvl0 gzcal"
        vc="gzlvl0=$VALUE/gzcal"
        set="$VALUE=gzlvl0*gzcal"
        digits="3"
        disable="Grayed out"
        />
      <entry loc="328 160" size="64 24"
        vq="gt0"
        vc="gt0=$VALUE"
        set="$VALUE=gt0"
        digits="6"
        disable="Grayed out"
        />

      <!-- Gradient Calibration Constants -->
      <label loc="120 240" size="32 24"
        label="gzcal"
        justify="Left"
        />
      <entry loc="168 240" size="64 24"
        vq="gzcal"
        vc="gzcal=$VALUE"
        set="$VALUE=gzcal"
        digits="6"
        disable="Grayed out"
        />

      <label loc="288 240" size="32 24"
        label="gstab"
        justify="Left"
        />
      <entry loc="328 240" size="64 24"
        vq="gstab"
        vc="gstab=$VALUE"
        set="$VALUE=gstab"
        digits="6"
        disable="Grayed out"
        />

      <!-- Magic Angle Option -->
      <check loc="8 240" size="104 24"
        style="Label2"
        label="Magic-Angle"
        vc="if pfgon='yyy' then mag_flg='y' endif"
        vc2="mag_flg='n'"
        set="if mag_flg='y' then $VALUE=1 else $VALUE=0 endif"
        tooltip="mag_flg='y' "
        />
    </group>

  </group>
</template>
```

### Common Template Patterns

#### Pattern 1: Conditional Parameter Visibility

Show parameter only when another parameter meets a condition:

```xml
<!-- Show ni2 entry only when ni2 > 1 -->
<entry loc="104 48" size="40 24"
  vq="ni2"
  vc="ni2=$VALUE"
  set="$VALUE=ni2"
  show="if (ni2=0) or (ni2=1) then $VALUE=0 else $VALUE=1 endif"
  />
```

#### Pattern 2: Calculated Display Values

Display a computed value (read-only):

```xml
<!-- Display resolution in Hz -->
<textmessage loc="80 24" size="32 16"
  vq="ni sw1"
  set="if ni&gt;1 then $VALUE=sw1/ni else $VALUE=0 endif"
  digits="0"
  />

<!-- Display total experiment time -->
<textmessage loc="136 0" size="56 24"
  vq="ni ni2 nt sw1 sw2 d1 at"
  set="$VALUE=(ni*ni2*nt*(d1+at))/3600.0"
  digits="2"
  />
```

#### Pattern 3: Parameter with Units Menu

Allow user to enter values in different units:

```xml
<entry loc="136 24" size="56 24"
  vq="sw"
  vc="vnmrunits('set','sw',$VALUE)"
  set="vnmrunits('get','sw'):$VALUE"
  digits="1"
  />
<menu loc="192 24" size="56 24"
  vq="sw"
  vc="parunits('set','sw','$VALUE')"
  set="parunits('get','sw'):$VALUE"
  editable="No"
  >
  <mlabel label="ppm" chval="ppm1"/>
  <mlabel label="Hz" chval="Hz"/>
</menu>
```

#### Pattern 4: Checkbox with Side Effects

Checkbox that changes multiple parameters:

```xml
<check loc="176 120" size="80 24"
  label="TROSY"
  vq="TROSY dm2"
  vc="TROSY='y' dm2='nnn'"
  vc2="TROSY='n' dm2='nny'"
  set="if TROSY='y' then $VALUE=1 else $VALUE=0 endif"
  />
```

#### Pattern 5: Linked Parameters (DAC ↔ G/cm)

Two entry fields for the same underlying value in different units:

```xml
<!-- Gradient level in DAC units -->
<entry loc="168 64" size="48 24"
  vq="gzlvl1"
  vc="gzlvl1=$VALUE"
  set="$VALUE=gzlvl1"
  digits="0"
  />

<!-- Same gradient in G/cm (calculated) -->
<entry loc="240 64" size="64 24"
  vq="gzlvl1 gzcal"
  vc="gzlvl1=$VALUE/gzcal"
  set="$VALUE=gzlvl1*gzcal"
  digits="3"
  />
```

**Note:** Both fields update the same parameter but show different units. The vq monitors both `gzlvl1` and `gzcal` so changes to either update the display.

#### Pattern 6: Phase Cycling Radio Buttons

Mutually exclusive acquisition modes:

```xml
<label loc="8 168" size="104 24"
  label="Acquisition Mode"
  />
<radio loc="32 192" size="128 24"
  label="First Increment"
  vq="phase"
  vc="phase=1"
  set="if phase=1 then $VALUE=1 else $VALUE=0 endif"
  />
<radio loc="32 216" size="128 24"
  label="Hypercomplex"
  vq="phase"
  vc="phase=1,2"
  set="$VALUE=0 $phase=size('phase') if $phase&gt;1.5 then $v=(phase[1]=1) $w=(phase[2]=2) $VALUE=($v and $w) endif"
  />
```

**Complex set expression explained:**
- `size('phase')` returns array size
- Check if phase[1]=1 AND phase[2]=2 for hypercomplex
- Return 1 (selected) only if both conditions met

#### Pattern 7: Grouped Related Parameters

Organize related parameters visually:

```xml
<group loc="352 0" size="400 120"
  border="Etched"
  subtype="Titled"
  >
  <label loc="8 0" size="200 24"
    style="Heading2"
    label="Water Suppression"
    />

  <!-- All water-related parameters here -->
  <check loc="8 30" size="120 24"
    label="Flipback"
    vq="flipback"
    vc="flipback='y'"
    vc2="flipback='n'"
    set="if flipback='y' then $VALUE=1 else $VALUE=0 endif"
    />

  <entry loc="140 30" size="48 24"
    vq="pwHs"
    vc="pwHs=$VALUE*1e-3"
    set="$VALUE=pwHs*1e3"
    show="if flipback='y' then $VALUE=1 else $VALUE=0 endif"
    digits="2"
    />
</group>
```

#### Pattern 8: Sequence Version Switcher Buttons

Allow switching between sequence variants:

```xml
<button loc="80 35" size="120 25"
  label="BioNMR Version"
  vq="seqfil layout"
  vc="seqfil='ghn_coP' layout=seqfil"
  tooltip="seqfil='ghn_coP'"
  />

<button loc="80 65" size="120 25"
  label="Pbox Version"
  vq="seqfil layout"
  vc="seqfil='ghn_coA' layout=seqfil"
  tooltip="seqfil='ghn_coA'"
  />
```

**Important:** `layout=seqfil` triggers VnmrJ to reload templates from the new sequence directory.

### Advanced Template Techniques

#### Technique 1: Context-Sensitive Help Tooltips

```xml
<entry loc="136 24" size="56 24"
  vq="sw"
  vc="vnmrunits('set','sw',$VALUE)"
  set="vnmrunits('get','sw'):$VALUE"
  tooltip="Spectral width in F3 (direct dimension). Enter value and select units."
  />
```

#### Technique 2: Conditional Groups (Entire Sections)

Show/hide entire parameter groups:

```xml
<!-- Only show 2H decoupling if 4-channel system -->
<group loc="0 150" size="300 80"
  show="if numrfch&gt;3 then $VALUE=1 else $VALUE=0 endif"
  border="Etched"
  >
  <label loc="8 0" size="200 24"
    style="Heading2"
    label="Deuterium Decoupling"
    />

  <entry loc="8 30" size="48 24"
    vq="dpwr3"
    vc="dpwr3=$VALUE"
    set="$VALUE=dpwr3"
    />
</group>
```

#### Technique 3: Parameter Validation

Use `show` to gray out invalid entries:

```xml
<!-- Gray out gain entry when gain='n' (auto) -->
<entry loc="136 160" size="24 24"
  vq="gain"
  vc="gain=$VALUE"
  set="$VALUE=gain"
  show="on('gain'):$VALUE"
  />
```

**Note:** `on('gain')` returns 1 if gain is a number, 0 if gain='n'

#### Technique 4: Dynamic Label Updates

Label text that changes based on parameters:

```xml
<label loc="8 0" size="232 24"
  style="Heading2"
  vq="ni sspul"
  set="if sspul='y' then $VALUE='F1 Acq: 13C (with SS)' else $VALUE='F1 Acquisition: 13C' endif"
  />
```

#### Technique 5: Array Parameter Display

Handle array parameters (phase=1,2):

```xml
<textmessage loc="100 50" size="80 20"
  vq="phase"
  set="$VALUE='' $s=size('phase') $i=1 while $i<=$s do format(phase[$i],0,0):$v $VALUE=$VALUE+$v if $i<$s then $VALUE=$VALUE+',' endif $i=$i+1 endwhile"
  />
```

This displays phase array as comma-separated values (e.g., "1,2").

### Template Debugging

#### Common Issues and Solutions

**Problem 1: Template doesn't load**

Check:
- XML syntax errors (missing quotes, unclosed tags)
- File encoding (must be UTF-8)
- DEFAULT file points to valid template set
- acq.xml has correct reference names

**Debug:**
```bash
# Check XML syntax
xmllint --noout templates/layout/my_sequence/Acquisition.xml

# Check for encoding issues
file templates/layout/my_sequence/*.xml
```

**Problem 2: Parameter doesn't update when changed**

Check:
- `vc` command syntax is valid MAGICAL code
- Parameter name spelled correctly in vq, vc, set
- No conflicts with multiple elements controlling same parameter

**Debug in VnmrJ:**
```
# Watch parameter changes
dg    # Display parameter groups
```

**Problem 3: Calculated values don't update**

Check:
- All dependent parameters listed in `vq`
- `set` expression uses correct syntax
- Comparison operators escaped (&lt; &gt; instead of < >)

**Example fix:**
```xml
<!-- WRONG: < not escaped -->
<textmessage vq="ni" set="if ni<2 then $VALUE=0 endif"/>

<!-- RIGHT: Use &lt; -->
<textmessage vq="ni" set="if ni&lt;2 then $VALUE=0 endif"/>
```

**Problem 4: Layout looks wrong**

Check:
- `loc="x y"` positions are reasonable (0,0 is top-left)
- `size="width height"` dimensions fit within parent group
- Overlapping elements (use unique positions)
- Border/padding adds to size

**Standard dimensions:**
- Tab group: size="784 272" or "752 272"
- F3 acquisition group: size="256 248"
- F1/F2 acquisition groups: size="243 248" or "248 248"

**Problem 5: Template changes don't appear**

**Solutions:**
```
# In VnmrJ command line:
layout=seqfil    # Reload current layout

# Or restart VnmrJ to clear cache
```

### Best Practices

1. **Always escape XML special characters in expressions:**
   - `<` → `&lt;`
   - `>` → `&gt;`
   - `&` → `&amp;`
   - `"` → `&quot;` (in attribute values)

2. **Use consistent positioning grid:**
   - Align elements to 8-pixel grid for clean appearance
   - Standard label height: 24 pixels
   - Standard entry height: 24 pixels
   - Vertical spacing: 24-26 pixels between rows

3. **Group related parameters:**
   - Use `<group border="Etched">` for visual grouping
   - Add heading labels with `style="Heading2"`

4. **Provide visual feedback:**
   - Use `disable="Grayed out"` for read-only parameters
   - Use `show` to hide irrelevant parameters
   - Add tooltips for complex parameters

5. **Follow BioPack conventions:**
   - F3 (direct) on left
   - F1 (first indirect) in middle
   - F2 (second indirect) on right
   - Gradients in separate tab or group

6. **Test thoroughly:**
   - Test with ni=0, ni=1, ni>1
   - Test all checkboxes and radio buttons
   - Verify calculated values update correctly
   - Test parameter limits (min/max values)

7. **Document custom templates:**
   - Add comments in XML explaining complex logic
   - Note parameter dependencies
   - Document any non-standard behaviors

### Template File Checklist

When creating new templates, verify:

- [ ] `DEFAULT` file exists and points to valid base
- [ ] `acq.xml` defines all tabs with correct references
- [ ] `Acquisition.xml` has groups for each dimension (F1, F2, F3)
- [ ] `PulseSequence.xml` has sequence-specific parameters
- [ ] All `vq` parameters exist in parameter set
- [ ] All `vc` commands use valid MAGICAL syntax
- [ ] All `set` expressions return proper values
- [ ] XML special characters escaped in all expressions
- [ ] Element positions don't overlap
- [ ] Element sizes fit within parent groups
- [ ] Tooltips added for non-obvious parameters
- [ ] Tested parameter updates work bidirectionally
- [ ] Tested conditional visibility works correctly
- [ ] Tested with different parameter values (edge cases)

## Development Workflow

### Compiling Pulse Sequences

BioPack sequences are compiled using the VnmrJ PSG compiler:

```bash
# Compile a single sequence
seqgen sequence_name

# Or using the macro system
dps  # Display pulse sequence and compile if needed
```

Compiled sequences are stored as 32-bit ELF executables in the `seqlib/` directory. The VnmrJ system automatically finds and executes these compiled sequences during NMR experiments.

Note: For VnmrJ 2.2C and later with "appdir" installations, sequences are in `/vnmr/biopack/psglib` or `~/vnmrsys/biopack/psglib`, not in the appdir path.

### Creating New Sequences

1. New sequences should include appropriate headers:
   ```c
   #include "bionmr.h"      // For "P" versions
   // OR
   #include "Pbox_bio.h"    // For "A" versions
   #include "Pbox_psg.h"
   ```

2. Follow existing naming conventions for consistency

3. Create corresponding files:
   - `psglib/sequence_name.c` - Pulse sequence code
   - `maclib/sequence_name` - Setup macro
   - `parlib/sequence_name.par` - Default parameters
   - `manual/sequence_name` - Documentation
   - `templates/layout/sequence_name/` - VnmrJ GUI layouts

### Macro Development

Setup macros are written in the VnmrJ/MAGICAL scripting language (a proprietary NMR-specific language). Key syntax:
- Variables are assigned with `=` (e.g., `ni=0`)
- Comments use `#` or are in quotes after "macro name"
- Functions are called with parentheses (e.g., `BPrtppar('sequence')`)
- String variables use single quotes
- Conditionals: `if (condition) then ... else ... endif`

Setup macros typically follow this pattern:

```
"macro sequence_name"

BPrtppar('sequence_name')  # Load parameters from probefile

setfrq BPsetampmode        # Set frequencies and amplitude mode

# Get probe-specific parameters
getparam('param_name','nucleus'):variable_name

# Set sequence-specific parameters
dof = dof - (174-offset)*dfrq  # Adjust C13 offset

# Initialize acquisition parameters
ni=0 ni2=0 phase=1 phase2=1
```

### Parameter Conventions

Important parameter types:

- **pw, pwC, pwN** - 90° pulse widths for H, C13, N15
- **tpwr, pwClvl, pwNlvl** - Power levels
- **dof, dof2, dof3** - Transmitter offsets for channels 1-3
- **dm, dm2, dm3** - Decoupling modes (typically 'nny' for N15 decoupling)
- **gt0-gt10, gzlvl0-gzlvl10** - Gradient times and levels
- **ni, ni2, ni3** - Number of increments in indirect dimensions
- **phase, phase2** - Phase cycling for States-TPPI

## Special Considerations

### Console Compatibility

- Designed for UNITYplus, UNITY INOVA, and DirectDrive (VNMRS) systems
- Requires linear amplifiers, waveform generators, pulsed field gradients
- 3 RF channels minimum (4 for 2H decoupling)
- SpinCAD versions (suffix "SP") require UNITY INOVA, not compatible with DirectDrive

### Water Suppression

Multiple methods available:
- WATERGATE (soft pulses, 3-9-19, W5)
- WET (multiple selective pulses)
- Presaturation
- Jump-return
- Flipback pulses

### Deuterium Decoupling

For deuterated samples:
- Set `dm3='nyn'` for 2H decoupling
- Requires 4-channel spectrometer
- Decoupling during periods when CA/CB magnetization is transverse

### Non-Linear Sampling (NLS)

BioPack supports non-linear sampling for faster 3D/4D acquisition:
- Sequences with `NLS` suffix
- Utilities in `bin/` directory
- Requires external processing (Orekhov scripts)

## Common Experiment Types

### Basic 2D Correlations
- `gNhsqc` / `gNfhsqc` - N15-HSQC (fast version)
- `gChsqc` / `gCfhsqc` - C13-HSQC
- `gNhmqc` / `gChmqc` - HMQC variants

### Triple Resonance (Backbone Assignment)
- `ghn_co` - HNCO
- `ghn_ca` - HNCA
- `ghn_cacb` - HNCACB
- `ghn_co_ca` - HN(CO)CA
- `ghn_ca_co` - HN(CA)CO
- `gcbca_co_nh` - CBCA(CO)NH

### Sidechain Assignment
- `hcch_tocsy` - HCCH-TOCSY
- `hcch_cosy` - HCCH-COSY
- `gc_co_nh` - C(CO)NH
- `ghc_co_nh` - H(CCO)NH

### Dynamics/Relaxation
- `gNT1` - N15 T1
- `gNT2` - N15 T2
- `gNNOE` - N15 NOE
- `gNT1T2` - Combined T1/T2

### Structure (NOE)
- `gnoesyNhsqc` - 3D N15-edited NOESY
- `gnoesyChsqc` - 3D C13-edited NOESY
- `CN4Dnoesy_trosyA` - 4D C/N-edited NOESY

## Troubleshooting

### Common Issues

1. **Shape file not found** - Run autocal/autoupdate or use "A" version sequences
2. **Power level errors** - Check probe file calibrations, ensure `BPpwrlimits` set correctly
3. **Water suppression poor** - Adjust flipback pulse power (tpwrsf), check gradient levels
4. **Compilation errors on RHEL 5.1+** - Use `psg_abort(1)` instead of `abort()` or `exit()`

### Legacy Compatibility

- BioPack merged ProteinPack and RnaPack
- Some legacy sequences may exist in `BioPack.dir/legacy_files`
- Check `BioPack.dir/BP_rev` for version information
